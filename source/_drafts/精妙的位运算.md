---
title: 精妙的位运算
tags: Android
categories:
---

## 位运算

- 与运算（and）

  `&`表示，当两个相同位对应的数都是 1 的时候，该位获得的结果才是 1，否则为 0
  例如说`6 & 11`，转换为二进制就是`0110 & 1011`，结果为`0010`。


- 或运算（or）

  `|`表示，当两个相同位对应的数只要有一个数 1 的时候，该位获得的结果为 1，否则为 0
  还是用 6 和 11 这两个数做例子，就是`0110 | 1011 = 1111`。


- 非运算（not）

  `~`表示将每一位按位取反（原来是 0 结果就是 1，原来是 1 结果就是 0）。`~110 = 001`
  在对Int值进行非运算时，因为计算机中存储的是补码，此时的非运算对补码进行取反后，再还原为原码后就会变为奇怪的值。
	[为何\~1等于-2，\~0等于-1呢](https://bbs.csdn.net/wap/topics/100095663)


- 异或运算（xor）

  `^`表示，当两个相同位对应的数字**不同**的时候为 1，否则为 0，可以用`A ^ B == 0`来判断两个数是否相等。
  例如说：`0110 ^ 1011 = 1101`。


- 左移（shl）

  `<<`表示，`a << b`表示 a 左移 b 位，由于移位在末位多出来的未知数字补零。
  在这里面可以等价为`a * 2^b`这个运算（针对十进制）。`0001 << 1 = 0010` 相当于`1 * 2^1 = 2`


- 右移（shr）

  `>>`表示，`a >> b`表示将 a 右移 b 位，原本的末位进行右移后会被舍弃，左边的用原有标志位补充，正数补0，负数补1。同样的，右移在十进制里面也可以近似为`a / (2^b)`的形式，不过要对结果取整，也不一定准确，只能够说意思大概如此。


- 无符号右移

  `>>>`表示，不管正负标志位为 0 还是 1，将该数的二进制码整体右移，左边部分总是以 0 填充，右边部分舍弃。

## 源码中的应用
### View
在`View.java`的源码中，各种View状态都是保存到类型为`Int`的`mViewFlags`字段中，每一位或多位代表一个属性的状态，例如`static final int ENABLED_MASK = 0x00000020;`代表了从二进制的右侧数第6位的值代表了当前是否为`ENABLED`状态。

`mViewFlags`共使用了32位来存储状态，源码中表示为`0x00000000`，每一个0都是4位。而`0x00000010`中1为使用该4位中的最后一位，相同的，2为第三位，4为第二位，8为第一位。

修改`mViewFlags`的值在`setFlags(flag,mask)`方法中：
```java View.java
    void setFlags(int flags, int mask) {
				// ...
        int old = mViewFlags;
        // 设置新的flag值
        mViewFlags = (mViewFlags & ~mask) | (flags & mask);
				// 判断是否值没有改变
        int changed = mViewFlags ^ old;
        if (changed == 0) {
            return;
        }
        // ...
    }
```
其中，`(mViewFlags & ~mask)`是将`mask`所标志的所在位原有值去除，`(flags & mask)`提取出要赋值的新值，并通过或运算`|`赋值至`mViewFlags`。此时新旧两值通过异或`^`判断值是否发生了改变。如果不相等，当前`changed`中为1的位为本次修改的位。

> 例如

### mask的作用
## 位运算的优势
省空间、高效(可以一次性修改好多属性)
## 参考文献

[弄懂 Android 源码中那些巧妙位运算](https://conorlee.top/2019/12/08/Android-bits-operation/)